<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Quiz</title>
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.js"></script>
  </head>
  <body>
    <div id="app">
      <section v-if="loading">
        <h2>Loading quiz, please wait...</h2>
      </section>

      <section v-if="error">
        <h2>{{ error }}</h2>
        <button @click="goBack">Back to Home</button>
      </section>

      <section v-if="hasQuestions() && !error && !loading">
        <h1>
          Question {{ currentQuestionIndex + 1 }} / {{ questions.length }}
        </h1>
        <h2>{{ questions[currentQuestionIndex].question }}</h2>

        <div>
          <label
            v-for="(option, key) in questions[currentQuestionIndex].options"
            :key="key"
          >
            <input type="radio" :value="key" v-model="selectedOption" />
            {{ option }}
          </label>
        </div>

        <button
          v-if="selectedOption !== null && !submitted"
          @click="submitOption"
        >
          Submit Answer
        </button>
      </section>

      <section v-if="submitted">
        <div v-if="isCorrect">
          <h4>You are Correct! Keep up the good work!</h4>
        </div>
        <div v-else>
          <h4>
            Oh no! The correct answer is {{
            questions[currentQuestionIndex].correctAnswer }}.
          </h4>
        </div>

        <button
          v-if="currentQuestionIndex === questions.length - 1"
          @click="finishQuiz"
        >
          Finish Quiz
        </button>
        <button v-else @click="nextQuestion">Next Question</button>
      </section>
    </div>

    <script>
      new Vue({
        el: "#app",
        data: {
          quizId: new URLSearchParams(window.location.search).get("quizId"),
          courseId: new URLSearchParams(window.location.search).get("courseId"),
          questions: [],
          currentQuestionIndex: 0,
          selectedOption: null,
          submitted: false,
          isCorrect: false,
          score: 0,
          loading: true,
          error: null,
        },
        mounted() {
          this.fetchQuiz();
        },
        methods: {
          async fetchQuiz() {
            if (!this.quizId || !this.courseId) {
              this.error = "Quiz ID or Course ID not specified.";
              this.loading = false;
              return;
            }

            try {
              const res = await fetch(
                `http://localhost:9000/api/quiz/${this.courseId}/${this.quizId}`
              );
              if (!res.ok)
                throw new Error("Quiz not found or failed to fetch.");
              const data = await res.json();

              this.questions = data.questions.map((q) => ({
                question: q.question,
                options: q.options,
                correctAnswer: q.correctAnswer,
              }));
            } catch (err) {
              console.error(err);
              this.error = "Failed to load the quiz. Please try again.";
            } finally {
              this.loading = false;
            }
          },
          hasQuestions() {
            return this.questions.length > 0;
          },
          submitOption() {
            if (this.selectedOption) {
              this.isCorrect =
                this.selectedOption ===
                this.questions[this.currentQuestionIndex].correctAnswer;
              this.submitted = true;
              this.score += this.isCorrect ? 1 : 0;
            }
          },
          nextQuestion() {
            this.submitted = false;
            this.selectedOption = null;
            if (this.currentQuestionIndex < this.questions.length - 1) {
              this.currentQuestionIndex++;
            }
          },
          async finishQuiz() {
            const userId = localStorage.getItem("userId");
            if (!userId) {
              alert("User ID not found in localStorage.");
              return;
            }

            try {
              // 1. POST to course logs
              const postRes = await fetch("http://localhost:5003/courseLogs", {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify({
                  courseId: this.courseId,
                  userId: userId,
                  completedItem: this.quizId,
                }),
              });

              if (!postRes.ok) throw new Error("Failed to log completion");

              // 2. GET next item from takecourse
              const takeRes = await fetch(
                `http://localhost:5001/takeCourse/${this.courseId}/${userId}`
              );
              const takeData = await takeRes.json();

              if (takeData.code === 200 && takeData.data?.redirectUrl) {
                window.location.href = takeData.data.redirectUrl;
              } else {
                alert("Quiz complete! No more content.");
              }
            } catch (err) {
              console.error(err);
              alert("An error occurred while finishing the quiz.");
            }
          },
          goBack() {
            if (this.courseId) {
              window.location.href = `takeCourse.html?courseId=${this.courseId}`;
            } else {
              window.location.href = "index.html";
            }
          },
        },
      });
    </script>
  </body>
</html>
