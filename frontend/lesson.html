<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Lesson Viewer</title>
    <script src="https://unpkg.com/vue@3"></script>
    <style>
      body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: #f0f2f5;
        margin: 0;
        padding: 0;
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      .container {
        max-width: 800px;
        width: 100%;
        background: #fff;
        padding: 30px;
        margin: 40px 20px;
        border-radius: 12px;
      }

      h1 {
        font-size: 32px;
        text-align: center;
        margin-bottom: 30px;
        color: #007acc;
      }

      label, select {
        font-size: 16px;
      }

      select {
        padding: 10px;
        width: 100%;
        margin-bottom: 20px;
        border: 1px solid #ccc;
        border-radius: 6px;
      }

      .lesson-title {
        font-size: 24px;
        font-weight: 600;
        margin: 20px 0 10px;
        color: #333;
        text-align: center;
      }

      iframe {
        width: 100%;
        height: 420px;
        border: none;
        border-radius: 8px;
        margin-bottom: 30px;
      }

      .nav-buttons {
        display: flex;
        justify-content: space-between;
        gap: 10px;
      }

      button {
        padding: 12px 24px;
        font-size: 16px;
        background-color: #007acc;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        flex: 1;
        transition: background-color 0.3s ease;
      }

      button:hover:not(:disabled) {
        background-color: #005fa3;
      }

      button:disabled {
        background-color: #ccc;
        cursor: not-allowed;
      }

      @media (max-width: 600px) {
        iframe {
          height: 250px;
        }

        .lesson-title {
          font-size: 20px;
        }
      }
    </style>
  </head>
  <body>
    <div id="app" class="container">
      <h1>Lesson Viewer</h1>

      <label for="lesson-select">Choose a lesson:</label>
      <select id="lesson-select" v-model="currentLessonIndex" @change="displayLesson(currentLessonIndex)">
        <option v-for="(lesson, index) in lessons" :value="index">{{ lesson.title }}</option>
      </select>

      <div class="lesson-title">{{ currentLesson.title }}</div>
      <iframe :src="getEmbedUrl(currentLesson.content)" allowfullscreen></iframe>

      <div class="nav-buttons">
        <button @click="prevLesson" :disabled="currentLessonIndex === 0">‚Üê Previous</button>
        <button @click="handleNext" :disabled="currentLessonIndex === lessons.length - 1">Next ‚Üí</button>
      </div>
    </div>

    <script>
      const STORAGE_KEY_PREFIX = "currentLessonIndex_";

      Vue.createApp({
        data() {
          return {
            courseId: "",
            lessons: [],
            currentLessonIndex: 0,
          };
        },
        computed: {
          currentLesson() {
            return this.lessons[this.currentLessonIndex] || { title: "", content: "", lessonId: "" };
          },
          storageKey() {
            return STORAGE_KEY_PREFIX + this.courseId;
          }
        },
        methods: {
          getCourseIdFromUrl() {
            const params = new URLSearchParams(window.location.search);
            this.courseId = params.get("courseId") || "401"; // fallback if none
          },
          async fetchLessons() {
            try {
              const url = `https://personal-m8gbmgkk.outsystemscloud.com/LessonService/rest/LessonAPI/lesson/by-course/${this.courseId}`;
              const response = await fetch(url);
              this.lessons = await response.json();

              const savedIndex = parseInt(localStorage.getItem(this.storageKey));
              if (!isNaN(savedIndex) && savedIndex >= 0 && savedIndex < this.lessons.length) {
                this.currentLessonIndex = savedIndex;
              }
            } catch (error) {
              alert("Failed to load lessons.");
              console.error(error);
            }
          },
          getEmbedUrl(url) {
            const match = url.match(/(?:v=|\/embed\/|\.be\/)([\w-]+)/);
            return match ? `https://www.youtube.com/embed/${match[1]}` : '';
          },
          displayLesson(index) {
            this.currentLessonIndex = index;
            localStorage.setItem(this.storageKey, index);
          },
          prevLesson() {
            if (this.currentLessonIndex > 0) this.displayLesson(this.currentLessonIndex - 1);
          },
          async handleNext() {
            const userId = localStorage.getItem("userId");
            if (!userId) {
              alert("User not logged in.");
              return;
            }

            const completedLessonId = this.currentLesson.lessonId || this.currentLesson.id || this.currentLesson.title;

            try {
              // 1. POST to Course Logs
              const logRes = await fetch("http://localhost:5003/courseLogs", {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify({
                  courseId: this.courseId,
                  userId: userId,
                  completedItem: completedLessonId,
                }),
              });

              const logData = await logRes.json();

              if (logRes.ok && logData.code === 200) {
                // Move to next lesson
                if (this.currentLessonIndex < this.lessons.length - 1) {
                  this.displayLesson(this.currentLessonIndex + 1);
                } else {
                  alert("üéâ You've completed all lessons!");
                }
              } else {
                alert("Failed to log lesson completion.");
              }
            } catch (err) {
              console.error("Course log error:", err);
              alert("An error occurred while logging progress.");
            }
          }
        },
        mounted() {
          this.getCourseIdFromUrl();
          this.fetchLessons();
        },
      }).mount("#app");
    </script>
  </body>
</html>
